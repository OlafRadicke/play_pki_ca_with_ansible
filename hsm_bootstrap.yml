---

- name:  Setup HSM
  hosts: yubihsm2
  roles:
    -    hsm_software_install
    -    hsm_start_service
    -    hsm_soft_factory_reset
    -    hsm_change_factory_password
    -    hsm_create_ca_keys

- name:  Setup HSM root ca
  hosts: yubihsm2
  roles:
    -    set_special_host_facts
    -    pre_update_and_install
    -    pre_config

- name:  Create intermediate ca csr
  hosts: hsm_policy_ca
  roles:
    -   { role: hsm_intermediate_ca_csr, when: "yubi_hsm_enable == true" }
    -   { role: intermediate_ca_csr, when: "yubi_hsm_enable == false" }

- name:  Create root ca self signing certificate
  hosts: hsm_root_ca
  roles:
    -   { role: hsm_root_ca_self_signing, when: "yubi_hsm_enable == true" }
    -   { role: root_ca_self_signing, when: "yubi_hsm_enable == false" }

- name:  Create intermediate ca signing certificate of root ca
  hosts: hsm_root_ca
  roles:
    -   { role: hsm_intermediate_ca_signing, when: "yubi_hsm_enable == true" }
    -   { role: intermediate_ca_signing, when: "yubi_hsm_enable == false" }