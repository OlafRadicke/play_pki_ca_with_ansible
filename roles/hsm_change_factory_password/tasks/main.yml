---


- name:           Is factory key exist
  shell:          |
                  yubihsm-shell                                           \
                      --action=list-objects                                   \
                      --domains={{ main_domain }}                             \
                      --object-type=any                                       \
                      --algorithm=any                                         \
                      --authkey="{{ hsm_key.yubi_factory.hex_id }}"           \
                      --password={{ hsm_key.yubi_factory.password }}          \
                      2>&1                                                    \
                      | grep "Found 1 object"                                 \
                      | wc -l
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Is factory key exist
  shell:          |
                  [[                                                          \
                    $(                                                        \
                      yubihsm-shell                                           \
                      --action=list-objects                                   \
                      --domains={{ main_domain }}                             \
                      --object-type=any                                       \
                      --algorithm=any                                         \
                      --authkey="{{ hsm_key.yubi_factory.hex_id }}"           \
                      --password={{ hsm_key.yubi_factory.password }}          \
                      2>&1                                                    \
                      | grep "Found 1 object"                                 \
                      | wc -l                                                 \
                    ) != 0                                                    \
                    ]]                                                        \
                    && echo true                                              \
                    || echo false
  register:       is_factory_key_exist
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ is_factory_key_exist }}"
  when:           debug_output

###############################################################################


- name:           Create new audit auth key
  shell:          |
                  yubihsm-shell                                               \
                    --action=put-authentication-key                           \
                    --object-id={{ hsm_key.audit_auth.str_id }}               \
                    --label="{{ hsm_key.audit_auth.label }}"                  \
                    --capabilities="all"                                      \
                    --object-type="all"                                       \
                    --delegated="all"                                         \
                    --new-password="{{ hsm_key.audit_auth.password }}"        \
                    --authkey="{{ hsm_key.yubi_factory.hex_id }}"             \
                    --password="{{ hsm_key.yubi_factory.password }}"
  register:       shell_result
  when:           true #is_factory_key_exist.stdout == 'true'
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Get hsm objects
  shell:          |
                  yubihsm-shell                                               \
                    --action=list-objects                                     \
                    --domains={{ main_domain }}                               \
                    --object-type=any                                         \
                    --algorithm=any                                           \
                    --authkey="{{ hsm_key.audit_auth.hex_id }}"               \
                    --password={{ hsm_key.audit_auth.password }}              \
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Delete factory key
  shell:          |
                  yubihsm-shell                                               \
                    --action=delete-object                                    \
                    --object-id="{{ hsm_key.yubi_factory.str_id }}"           \
                    --object-type="authentication-key"                        \
                    --authkey="{{ hsm_key.audit_auth.hex_id }}"               \
                    --password="{{ hsm_key.audit_auth.password }}"
  register:       shell_result
  when:           true # is_factory_key_exist.stdout == 'true'
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Create test objekt with new password
  shell:          |
                  yubihsm-shell                                               \
                    --action=put-authentication-key                           \
                    --object-id={{ hsm_key.test.str_id }}                     \
                    --capabilities='all'                                      \
                    --object-type="all"                                       \
                    --delegated="all"                                         \
                    --label="{{ hsm_key.test.label }}"                        \
                    --new-password="{{ hsm_key.test.password }}"              \
                    --authkey="{{ hsm_key.audit_auth.hex_id }}"               \
                    --password="{{ hsm_key.audit_auth.password }}"
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output


###############################################################################

- name:           Check test objekt
  shell:          |
                  yubihsm-shell                                               \
                    --action=get-object-info                                  \
                    --object-id={{ hsm_key.test.str_id }}                     \
                    --object-type=authentication-key                          \
                    --algorithm=any                                           \
                    --authkey={{ hsm_key.audit_auth.hex_id }}                 \
                    --password="{{ hsm_key.audit_auth.password }}"
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output


###############################################################################

- name:           Delete test object
  shell:          |
                  yubihsm-shell                                               \
                    --action=delete-object                                    \
                    --object-id="{{ hsm_key.test.str_id }}"                   \
                    --object-type="authentication-key"                        \
                    --authkey="{{ hsm_key.audit_auth.hex_id }}"               \
                    --password="{{ hsm_key.audit_auth.password }}"
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output