server {
  listen                  80;
  server_name             {{ end_entity.common_name }};
  rewrite                 ^ https://{{ end_entity.common_name }} permanent;
}

server {
  listen                  {{ service_port }} ssl http2;
  server_name             {{ end_entity.common_name }};

  ssl                     on;
  ssl_certificate         {{ pki_bundle_file }};
  ssl_certificate_key     {{ pki_priv_key }};
  ssl_protocols           TLSv1.2;

  ssl_verify_client       optional;
  ssl_client_certificate  {{ pki_bundle_file }};
  ssl_verify_depth        5;

  root                    {{ pki_service_http_root_dir }}/;
  error_log               /srv/http/debug.log debug;

  location                /oneway/ {
    autoindex             on;
  }

  location                /mutual/ {
    if                    ($ssl_client_verify != SUCCESS) {
      return              403;
    }
    autoindex             on;
  }

  location                /company-mutual/ {
    if                    ($ssl_client_s_dn !~ "OU=Foobar staff department") {
      return              403;
    }
    autoindex             on;
  }
}
