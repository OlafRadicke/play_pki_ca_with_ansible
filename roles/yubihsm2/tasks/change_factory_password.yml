---

# Soft reset:
# yubihsm-shell -a reset -d 0 --authkey=0x0003 -p XXXXXXXXXXXXXXXXXX

# - name:           Get hsm objects
#   shell:          |
#                   yubihsm-shell                                               \
#                     --action=list-objects                                     \
#                     --domains={{ main_domain }}                               \
#                     --object-type=any                                         \
#                     --algorithm=any                                           \
#                     --password={{ yubi_factory_key.password }}                \
#   register:       shell_result
#   when:           debug_output
#   ignore_errors: "{{ debug_output }}"

# - name:           Output return value
#   debug:
#     msg:          "{{ shell_result }}"
#   when:           debug_output

###############################################################################


- name:           Is factory key exist
  shell:          |
                  [[                                                          \
                    $(                                                        \
                      yubihsm-shell                                           \
                      --action=list-objects                                   \
                      --domains={{ main_domain }}                             \
                      --object-type=any                                       \
                      --algorithm=any                                         \
                      --password={{ yubi_factory_key.password }}              \
                      2>&1                                                    \
                      | grep "Object not found"                               \
                      | wc -l                                                 \
                    ) == 0                                                    \
                    ]]                                                        \
                    && echo true                                              \
                    || echo false
  register:       is_factory_key_exist
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ is_factory_key_exist }}"
  when:           debug_output

###############################################################################


- name:           Create new audit auth key
  shell:          |
                  yubihsm-shell                                               \
                    --action=put-authentication-key                           \
                    --object-id={{ audit_auth_key.id }}                       \
                    --label="{{ audit_auth_key.label }}"                      \
                    --capabilities="all"                                      \
                    --object-type="all"                                       \
                    --delegated="all"                                         \
                    --new-password="{{ audit_auth_key.password }}"            \
                    --authkey="{{ yubi_factory_key.id }}"                     \
                    --password="{{ yubi_factory_key.password }}"
  register:       shell_result
  when:           is_factory_key_exist.stdout == 'true'
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Get hsm objects
  shell:          |
                  yubihsm-shell                                               \
                    --action=list-objects                                     \
                    --domains={{ main_domain }}                               \
                    --object-type=any                                         \
                    --algorithm=any                                           \
                    --authkey="{{ audit_auth_key.id }}"                       \
                    --password={{ audit_auth_key.password }}                  \
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Delete factory key
  shell:          |
                  yubihsm-shell                                               \
                    --action=delete-object                                    \
                    --object-id="{{ yubi_factory_key.id }}"                   \
                    --object-type="authentication-key"                        \
                    --authkey="{{ audit_auth_key.id }}"                       \
                    --password="{{ yubihsm2_password }}" 
  register:       shell_result
  when:           is_factory_key_exist.stdout == 'true'
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output

###############################################################################

- name:           Create test objekt with new password
  shell:          |
                  yubihsm-shell                                               \
                    --action=put-authentication-key                           \
                    --object-id={{ test_key.id }}                             \
                    --capabilities='all'                                      \
                    --object-type="all"                                       \
                    --delegated="all"                                         \
                    --label="{{ test_key.label }}"                            \
                    --new-password="{{ test_key.password }}"                  \
                    --authkey="{{ audit_auth_key.id }}"                       \
                    --password="{{ audit_auth_key.password }}"
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output


###############################################################################

- name:           Check test objekt
  shell:          |
                  yubihsm-shell --action=get-object-info                      \
                    --object-id={{ test_key.id }}                             \
                    --object-type=authentication-key                          \
                    --algorithm=any                                         \
                    --authkey={{ audit_auth_key.id }}                         \
                    --password="{{ audit_auth_key.password }}"
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output


###############################################################################

- name:           Delete test object
  shell:          |
                  yubihsm-shell                                               \
                    --action=delete-object                                    \
                    --object-id="{{ test_key.id }}"                           \
                    --object-type="authentication-key"                        \
                    --authkey="{{ audit_auth_key.id }}"                       \
                    --password="{{ yubihsm2_password }}" 
  register:       shell_result
  when:           debug_output
  ignore_errors: "{{ debug_output }}"

- name:           Output return value
  debug:
    msg:          "{{ shell_result }}"
  when:           debug_output